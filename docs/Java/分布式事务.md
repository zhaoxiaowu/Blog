## 事务

> 一系列操作要么都成功，要么都失败。只要一项操作失败，就会导致整个事务回滚

## 事务的四大特性

A(Automic):构成事务的所有操作，要么都执行完成，要么全部不执行，不可能出现部分成功，部分失败的情况。

C(Consistency):一致性，在事务执行后，数据库的一致性约束没有破坏。比如：张三向李四转了100元，转帐前和转账后数据时正确状态，叫一致性。

I(Isolation):隔离性，数据库事务都是并发的，隔离性是指并发的两个事务执行互不干扰

通过事务隔离级别可以避免脏读，重复读的问题

D(Durability):持久性，事务完成之后，该事务对数据的更改会被持久化到数据库，且不会被回滚

## 分布式事务

事务的操作位于不同的节点，需要保证事物的ACID特性



使用本地事务：

超时  b系统超时 无法解决。

## 分布式事务产生的场景

无法用本地数据库控制数据库事务 



1.微服务架构

跨JVM进程产生的事务

2.单体系统多个数据库实例

3.多个服务访问同一个数据库实例

跨JVM进程产生的事务



## CAP理论



> CAP  Consistency  Avaliablity  Partition rolerance三个单词的缩写，分别表示一致性、可用性、分区容忍性  （三选二）

实际上，基本都需要具备了P（分区容错性），必须在C（一致性）和A（可用性）之间任选其一。 AP在实际应用中较多，舍弃一致性，保证可用性 和分区容忍性。 但要保证最终一致性。

#### **一致性：**

是指写操作后 读操作可以读取到最新的数据状态，当数据分布在多个节点上，从任意节点读取到数据都是最新的状态

数据库读写分离例子：

如何实现一致性：

1.写入主数据库后要将数据同步到从数据库

2.写入主数据库后，在向从数据库同步期间要将数据库锁定，待同步完成后再释放锁，以免在

新数据写入成功后，向从数据库查询到旧的数据

分布式系统 一致性的特点。

1.由于存在数据同步的过程，写操作的响应 会有一定的延迟。

2.为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源。

3.如果请求数据同步失败的节点则会返回错误信息，一定不会返回旧数据

#### 可用性

是指任何事物操作都能得到响应结果，且不会出现相应超时 或者错误

如何实现可用性？

 1、写入主数据库后要将数据同步到从数据库。

 2、由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。

 3、即时数据还没有同步过来，从数据库也要返回要查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照 约定返回一个默认信息，但不能返回错误或响应超时。 

#### 分区容忍性

分布式系统部署在不同的子网，不可避免会出现由于网络问题而导致节点通信失败，此时仍可对外提供服务。

如何实现分区容忍性？

 1、尽量使用异步取代同步操作，例如使用异步方式将数据从主数据库同步到从数据，这样结点之间能有效的实现 松耦合。

 2、添加从数据库结点，其中一个从结点挂掉其它从结点提供服务。

 分布式分区容忍性的特点： 1、分区容忍性分是布式系统具备的基本能力。

## BASE理论

BASE理论是Basically Available(基本可用)，Soft State（软状态）和Eventually Consistent（最终一致性）三个短语的缩写。

其核心思想是：

> 既是无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。

当出现故障时允许部分不可用但要保证核心功能可用，牺牲强一致性 来获取可用性，允许数据在一段时间不一致，但最终达到一致状态。满足BASE理论的事务，我们称之为**柔性事务**。

**基本可用**:分布式系统在出现故障时，允许损失部分可用功能，保证核心功能可用。如，电商网站交易付款出 现问题了，商品依然可以正常浏览。

 **软状态:**由于不要求强一致性，所以BASE允许系统中存在中间状态（也叫软状态），这个状态不影响系统可用 性，如订单的"支付中"、“数据同步中”等状态，待数据最终一致后状态改为“成功”状态。 

**最终一致:**最终一致是指经过一段时间后，所有节点数据都将会达到一致。如订单的"支付中"状态，最终会变 为“支付成功”或者"支付失败"，使订单状态与实际交易结果达成一致，但需要一定时间的延迟、等待。

## 分布式事务解决方案

常见的有2PC，TCC,可靠消息最终一致性，最大努力通知

### 2PC

两阶段提交协议 ，整个事务分为两个阶段，P准备阶段、C提交阶段

部分关系型数据库 支持两阶段提交

1. 准备阶段（Prepare phase）：事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事 务，并写本地的Undo/Redo日志，此时事务没有提交。 （Undo日志是记录修改前的数据，用于数据库回滚，Redo日志是记录修改后的数据，用于提交事务后写入数 据文件） 
2. 提交阶段（commit phase）：如果事务管理器收到了参与者的执行失败或者超时消息时，直接给每个参与者 发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据事务管理器的指令执行提交或者回滚操 作，并释放事务处理过程中使用的锁资源。注意:必须在最后阶段释放锁资源。

#### XA方案

![image-20200515152459976](..\images\image-20200515152459976.png)

1.在准备阶段  RM执行  实际业务操作，但不提交事务，资源锁定。

2.提交阶段 回家收RM在准备阶段的执行回复，只要一个事务参与者失败，就会通知所有回滚。都成功就提交事务，

缺点:

数据库支持xa协议。

资源锁需要两阶段结束才释放，性能较差。

#### seata方案

是阿里中间件开源的分布式事务框架

传统2pc的问题在seata中解决，它通过对本地数据库分支事务的协调 来驱动完成全局事务，是工作在应用层的中间件。主要优点是性能好，且不长时间占用连接资源，他以搞笑的对业务0侵入的方式解决分布式事务问题。

## TCC

TCC是Try、Confirm、Cancel三个词语的缩写，TCC要求每个分支事务实现三个操作：预处理Try、确认
Confirm、撤销Cancel。Try操作做业务检查及资源预留，Confirm做业务确认操作，Cancel实现一个与Try相反的
操作即回滚操作。TM首先发起所有的分支事务的try操作，任何一个分支事务的try操作执行失败，TM将会发起所
有分支事务的Cancel操作，若try操作全部成功，TM将会发起所有分支事务的Confirm操作，其中Confirm/Cancel
操作若执行失败，TM会进行重试。  

TCC需要注意的三种异常处理 空回滚   幂等  悬挂

## 可靠消息最终一致性

可靠消息最终一致性方案是指当事务发起方执行完本地事务并发出一条消息，事务的参与方（消息消费者）一定能够接收消息并处理事务成功，此方案强调的是 只要消息发给事务参与者 最终事务要达到一致

1.本地消息和消息发送的原子性

2.事务参与方接收方接收消息要可靠

3.消费方重复消费问题

### 解决方案

##### 本地消息表

##### rocket 事务消息机制

MQ4.3支持事务消息

事务消息主要为了解决消息发送 和本地事务执行的原子性问题

## 最大努力通知

发起通知方 尽最大努力 将业务处理结果通知 接收方。但消息可能接收不到，此时需要接收方主动调用查询接口查询结果。

可靠消息一致性和最大努力通知业务场景

1.可靠消息一致性 关注的是交易过程事务一致，以异步的方式完成交易

2.最大努力通知 将交易结果通知出去