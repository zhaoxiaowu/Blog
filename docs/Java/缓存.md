### 当缓存不可用，怎么提交可用性？

缓存可以极大的提高查询性能，但是缓存数据丢失和缓存不可用不能影响应用的正常工作。

因此，一般情况下，如果缓存出现异常，需要手动捕获这个异常，并且记录日志，并且从数据库查询数据返回给用户，而不应该导致业务不可用。

### 使用缓存引入的问题

#### 写入问题

##### 缓存何时写入？如何避免并发重复写入？

##### 缓存如何失效？

##### 缓存和DB的一致性 如何保证？

#### 缓存穿透

为了容错考虑，缓存不存在，会DB查数据，然后写入缓存。

查询一个一定不存在的数据。

DB查不到不会写入缓存，这就会导致不存在数据每次都会查询DB,失去缓存的意义。



当流量大的时候DB就挂了，要是有人利用不存在的key频繁攻击，这就是漏洞

不一定是攻击，也可能是程序写的问题  或是  无脑爬虫

**解决：**布隆过滤器

存在误判：判断不存在则一定不存在，如果存在的话 不一定存在

#### 缓存击穿

缓存击穿，指某个热点数据在某个时间点过期时，恰好这个时间点这个key有大量的并发请求过来，这些请求过期的缓存都会从db加载数据   请求瞬间使db压垮  （这个值是真实存在的）

解决方案：

（1）.分布式锁

- 1、获取分布式锁，直到成功或超时。如果超时，则抛出异常，返回。如果成功，继续向下执行。
- 2、获取缓存。如果存在值，则直接返回；如果不存在，则继续往下执行。😈 因为，获得到锁，可能已经被“那个”线程去查询过 DB ，并更新到缓存中了。



#### 缓存雪崩

缓存由于某些原因无法提供服务，所有请求到达DB,导致DB负荷大增，最后挂掉

1.缓存高可用    

 Redis 作为缓存，则可以使用 Redis Sentinel 或 Redis Cluster 实现高可用。

2.本地缓存

如果使用本地缓存时，即使分布式缓存挂了，也可以将 DB 查询到的结果缓存到本地，避免后续请求全部到达 DB 中。

**基础配置  相关的 可以使用本地缓存** 

**优点：**

比redis更快    可用性高    

**问题：**

本地缓存实时性怎么保证

方案一，可以引入消息队列。在数据更新时，发布数据更新的消息；而进程中有相应的消费者消费该消息，从而更新本地缓存。

3）请求 DB 限流

通过限制 DB 的每秒请求数，避免把 DB 也打挂了。这样至少能有两个好处：

1. 可能有一部分用户，还可以使用，系统还没死透。

2. 未来缓存服务恢复后，系统立即就已经恢复，无需再处理 DB 也挂掉的情况。

   

### 缓存 一致性

更新缓存

先淘汰缓存  再写数据库



### 缓存预热

1.初始化的时候加载缓存

**参考：**

[精进缓存](http://svip.iocoder.cn/Cache/Interview/)